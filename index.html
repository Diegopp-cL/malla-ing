<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malla Interactiva de Carrera</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #e0f7fa, #b3e5fc); /* Degradado azul-celeste más suave */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem; /* Asegura padding en todos los tamaños de pantalla */
        }
        .container-wrapper {
            @apply max-w-7xl mx-auto w-full;
        }

        /* Estilos generales para las tarjetas de curso */
        .course-card {
            @apply bg-white p-6 rounded-xl shadow-lg transition-all duration-300 ease-in-out border relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transform-origin: center;
            cursor: pointer; /* Cursor por defecto */
        }
        .course-card:hover {
            @apply shadow-xl transform scale-102;
        }

        /* Estados de los cursos */
        .course-card.selected {
            @apply border-blue-600 ring-4 ring-blue-200 bg-blue-50;
        }
        .course-card.prerequisite {
            @apply border-yellow-500 ring-2 ring-yellow-300 bg-yellow-50;
        }
        .course-card.post-requisite {
            @apply border-green-500 ring-2 ring-green-300 bg-green-50;
        }

        /* Estado: Completado (Verde) */
        .course-card.completed {
            @apply bg-green-100 text-gray-600 opacity-90;
            border-color: #a7f3d0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation: completeFadeIn 0.3s ease-out forwards;
            cursor: default; /* No cambia el cursor al pasar el ratón */
        }
        .course-card.completed .course-name, .course-card.completed .course-credits {
            text-decoration: line-through;
            color: #4b5563;
        }
        .course-card.completed:hover { /* Anula el hover para completados */
            @apply transform-none shadow-lg;
        }

        /* Estado: Disponible / En Curso (Azul oscuro) */
        .course-card.available {
            @apply border-blue-600; /* Borde azul oscuro */
        }

        /* Estado: Bloqueado (Gris) */
        .course-card.locked {
            @apply bg-gray-200 text-gray-500 cursor-not-allowed opacity-70 border-gray-300;
            box-shadow: none;
        }
        .course-card.locked:hover { /* Anula el hover para bloqueados */
            @apply transform-none shadow-none;
        }
        .course-card.locked .course-name, .course-card.locked .course-credits {
            color: #9ca3af;
        }
        .course-card.locked .toggle-completion-icon svg {
            @apply text-gray-400; /* Icono gris para bloqueados */
        }

        /* Animación para la finalización */
        @keyframes completeFadeIn {
            from { transform: scale(0.95); opacity: 0.7; }
            to { transform: scale(1); opacity: 0.9; }
        }

        /* Estilos para el icono de alternar completado (cuadrado) */
        .toggle-completion-icon {
            @apply absolute top-3 right-3 z-50; /* Posicionado a la derecha */
            width: 32px; /* Ancho explícito */
            height: 32px; /* Alto explícito */
            display: flex; /* Usar flexbox para centrar SVG */
            justify-content: center;
            align-items: center;
            border-radius: 4px;
            cursor: pointer; /* Asegura que sea clickeable */
        }
        .toggle-completion-icon svg {
            @apply h-6 w-6 transition-colors duration-200; /* Tamaño del SVG */
        }
        .toggle-completion-icon.uncompleted svg {
            @apply text-gray-400 hover:text-blue-500;
        }
        .toggle-completion-icon.completed svg {
            @apply text-green-600;
        }
        .toggle-completion-icon.locked-icon {
            pointer-events: none; /* Deshabilita clics en el icono si el curso está bloqueado */
            cursor: not-allowed; /* Indica que no es clickeable */
        }

        /* Diseño de cuadrícula para semestres */
        .semester-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        /* Ajustar cuadrícula para pantallas más grandes */
        @media (min-width: 768px) {
            .semester-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .semester-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 1280px) {
            .semester-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        @media (min-width: 1536px) {
            .semester-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        /* Estilo para el panel de detalles */
        #course-details {
            @apply bg-white p-6 rounded-xl shadow-xl border border-gray-200 mt-8;
        }
        #course-details button {
            @apply px-5 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors duration-200 shadow-md;
        }

        /* Estilo para el mensaje de bloqueo persistente */
        #locked-course-info {
            @apply bg-red-100 text-red-700 border border-red-300 px-4 py-3 rounded-lg text-center font-medium mb-8 transition-opacity duration-300;
            min-height: 50px; /* Asegura un espacio mínimo */
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; /* Oculto por defecto */
        }
        #locked-course-info.active {
            opacity: 1; /* Visible cuando está activo */
        }

        /* Estilos para el indicador de carga */
        #loading-indicator {
            @apply fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-[100];
            color: white;
            font-size: 1.5rem;
            display: none; /* Oculto por defecto */
        }
        #loading-indicator.active {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="container-wrapper">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-4">Malla Interactiva de Carrera</h1>
        <p class="text-center text-gray-600 mb-2">
            Haz clic en el icono de de cuadrado, para marcar un curso como completado.
            Los cursos disponibles/en curso tienen un borde azul oscuro.
            Los cursos bloqueados (pre-requisitos no cumplidos) están en gris y no son interactivos.
            Haz clic en cualquier otra parte del curso (si está disponible) para ver sus detalles y resaltar sus pre-requisitos (amarillo) y post-requisitos (verde).
        </p>

        <!-- Nuevo div para el mensaje de cursos bloqueados -->
        <div id="locked-course-info" class="mb-8">
            <!-- El mensaje se inyectará aquí -->
        </div>

        <div id="curriculum-grid" class="semester-grid">
            <!-- Los cursos se inyectarán aquí mediante JavaScript -->
        </div>

        <div id="course-details" class="hidden">
            <h2 class="text-2xl font-semibold text-gray-700 mb-3">Detalles del Curso</h2>
            <p class="text-lg text-gray-800 mb-2"><strong>Nombre:</strong> <span id="detail-name"></span></p>
            <p class="text-md text-gray-600 mb-2"><strong>Créditos:</strong> <span id="detail-credits"></span></p>
            <p class="text-md text-gray-600 mb-2"><strong>Semestre:</strong> <span id="detail-semester"></span></p>
            <div class="mb-2">
                <strong class="text-md text-gray-600">Pre-requisitos:</strong>
                <ul id="detail-prerequisites" class="list-disc list-inside text-gray-700 pl-4">
                    <!-- Los pre-requisitos se listarán aquí -->
                </ul>
            </div>
            <div class="mb-2">
                <strong class="text-md text-gray-600">Post-requisitos:</strong>
                <ul id="detail-postrequisites" class="list-disc list-inside text-gray-700 pl-4">
                    <!-- Los post-requisitos se listarán aquí -->
                </ul>
            </div>
            <button id="close-details" class="mt-4">
                Cerrar Detalles
            </button>
        </div>
    </div>

    <!-- Indicador de carga -->
    <div id="loading-indicator">Cargando...</div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importaciones de Firebase SDKs. Estas son las únicas que necesitas.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ***** TU CONFIGURACIÓN DE FIREBASE *****
        // Esta es la única definición de firebaseConfig que debe existir.
        // REEMPLAZA LOS VALORES DE EJEMPLO CON LOS TUYOS REALES DE LA CONSOLA DE FIREBASE.
        const firebaseConfig = {
          apiKey: "AIzaSyB3KZeSDqI3HgS_tA6MMi4CLnEqA_i3rk4", // TU_API_KEY
          authDomain: "malla-ing.firebaseapp.com", // TU_AUTH_DOMAIN
          projectId: "malla-ing", // TU_PROJECT_ID
          storageBucket: "malla-ing.firebasestorage.app", // TU_STORAGE_BUCKET
          messagingSenderId: "45163661704", // TU_MESSAGING_SENDER_ID
          appId: "1:45163661704:web:3539b656e138f61c82523d", // TU_APP_ID
          measurementId: "G-P2S0KFFVZS" // Puedes dejarlo o quitarlo si no usas Analytics
        };
        // ****************************************

        // Usamos el projectId de tu configuración de Firebase como appId para la ruta de Firestore
        const appId = firebaseConfig.projectId;

        // Declaración de variables de Firebase (se inicializarán dentro del bloque try/catch)
        let app;
        let db;
        let auth;
        let userId = 'loading'; // Estado inicial del ID de usuario

        const loadingIndicator = document.getElementById('loading-indicator');
        // const userIdDisplay = document.getElementById('user-id-display'); // Ya no se usa para mostrar el ID

        // Nuevo elemento para el mensaje de curso bloqueado
        const lockedCourseInfoDiv = document.getElementById('locked-course-info');

        /**
         * Muestra u oculta el indicador de carga.
         * @param {boolean} show - True para mostrar, false para ocultar.
         */
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.add('active');
            } else {
                loadingIndicator.classList.remove('active');
            }
        }

        // Configuración e inicialización de la aplicación Firebase
        try {
            app = initializeApp(firebaseConfig); // Inicializa la aplicación Firebase
            db = getFirestore(app); // Obtiene la instancia de Firestore
            auth = getAuth(app); // Obtiene la instancia de autenticación

            // Listener de cambios en el estado de autenticación de Firebase
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid; // Asigna el ID del usuario autenticado
                    // userIdDisplay.textContent = `ID de Usuario: ${userId}`; // Ya no se muestra el ID del usuario directamente
                    console.log("Usuario autenticado:", userId);
                    // Una vez autenticado, carga y escucha los datos de progreso del usuario desde Firestore
                    loadCompletedCoursesFromFirestore();
                } else {
                    // Si no hay usuario autenticado, intenta la autenticación anónima
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error al autenticar anónimamente:", error);
                        // userIdDisplay.textContent = "Error al cargar usuario. Intenta recargar la página."; // Mensaje de error más discreto
                        showLoading(false);
                    }
                }
            });

        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            // userIdDisplay.textContent = "Error de configuración de Firebase. Revisa tu consola."; // Mensaje de error más discreto
            showLoading(false);
        }

        // --- Datos y Lógica de la Malla Interactiva ---
        // Define los cursos de tu carrera. Modifica esta sección para que coincida con tu malla.
        const courses = [
            // Semestre 1
            { id: 'FITCX001', name: 'Formación Integral - Vida Saludable', semester: 1, credits: 6, prerequisites: [] },
            { id: 'INFOB010', name: 'Introducción a la Ingeniería en Computación', semester: 1, credits: 6, prerequisites: [] },
            { id: 'QUICX001', name: 'Química General', semester: 1, credits: 3, prerequisites: [] },
            { id: 'MATCX001', name: 'Taller de Matemáticas', semester: 1, credits: 2, prerequisites: [] },
            { id: 'NIVEB010', name: 'Habilidades de Razonamiento Lógico', semester: 1, credits: 6, prerequisites: [] },
            { id: 'NIVEB020', name: 'Habilidades de Trabajo Académico', semester: 1, credits: 4, prerequisites: [] },

            // Semestre 2
            { id: 'INFB8021', name: 'Algoritmo y Programacion', semester: 2, credits: 3, prerequisites: [] },
            { id: 'MATCX002', name: 'Cálculo Diferencial', semester: 2, credits: 7, prerequisites: ['MATCX001'] },
            { id: 'QUICX002', name: 'Álgebra y Geometría', semester: 2, credits: 3, prerequisites: [] },
            { id: 'MATCX003', name: 'Ciencia de los Materiales', semester: 2, credits: 2, prerequisites: ['QUICX001'] },
            { id: 'FISCX001', name: 'Mecánica Clásica', semester: 2, credits: 2, prerequisites: [] },

            // Semestre 3
            { id: 'MATCX004', name: 'Cálculo Integral', semester: 3, credits: 7, prerequisites: ['MATCX002'] },
            { id: 'FISCX002', name: 'Electromagnetismo', semester: 3, credits: 3, prerequisites: ['FISCX001'] },
            { id: 'MATCX005', name: 'Álgebra Matricial', semester: 3, credits: 2, prerequisites: ['QUICX002'] },
            { id: 'INFOB030', name: 'Estructuras de Datos', semester: 3, credits: 3, prerequisites: ['INFOB010'] },
            { id: 'ESTCO001', name: 'Estadística y Probabilidad', semester: 3, credits: 3, prerequisites: ['MATCX002'] },
            { id: 'FITCXX02', name: 'Pensamiento Critico', semester: 3, credits: 1, prerequisites: [] },

            // Semestre 4
            { id: 'MATCX006', name: 'Cálculo en Varias Variables', semester: 4, credits: 3, prerequisites: ['MATCX004'] },
            { id: 'FISC0004', name: 'Optica y Ondas', semester: 4, credits: 2, prerequisites: ['FISCX002'] },
            { id: 'FITCX004', name: 'Formación Integral - Ciudadanía', semester: 4, credits: 3, prerequisites: [] },
            { id: 'INFOB040', name: 'Lenguajes de Programación', semester: 4, credits: 2, prerequisites: ['INFOB030'] },
            { id: 'MATCX007', name: 'Ecuaciones Diferenciales', semester: 4, credits: 2, prerequisites: ['MATCX004'] },
            { id: 'ESTC001', name: 'Estadistica y Probabilidad', semester: 4, credits: 2, prerequisites: ['QUICX002'] },

            // Semestre 5
            { id: 'INDC0003', name: 'Administracion', semester: 5, credits: 3, prerequisites: ['INDC0001'] },
            { id: 'MECCX001', name: 'Termodinámica', semester: 5, credits: 2, prerequisites: ['MATC0006'] },
            { id: 'INFOB051', name: 'Gráficos y Lenguajes Formales', semester: 5, credits: 2, prerequisites: ['INFB8040'] },
            { id: 'INFOB050', name: 'Bases de Datos', semester: 5, credits: 2, prerequisites: ['INFB8030'] },
            { id: 'INFOB060', name: 'Tecnología de Computadores', semester: 5, credits: 3, prerequisites: ['MATC0005'] },
            { id: 'FITCX005', name: 'Formación Integral Ética', semester: 5, credits: 2, prerequisites: [] },

            // Semestre 6
            { id: 'INDC0002', name: 'Investigacion de Operaciones', semester: 6, credits: 3, prerequisites: ['MATC0007'] },
            { id: 'PRMC0001', name: 'Ingenieria Ambiental', semester: 6, credits: 1, prerequisites: ['MECC0001'] },
            { id: 'INFB8062', name: 'Sistemas de Informacion', semester: 6, credits: 2, prerequisites: ['INFB8050'] },
            { id: 'INFB8060', name: 'Arquitectura de Computadores', semester: 6, credits: 2, prerequisites: ['MATC0005'] },
            { id: 'HUMC0001', name: 'Inglés I', semester: 6, credits: 2, prerequisites: [] },
            { id: 'INDC0004', name: 'Introduccion a la Economia', semester: 6, credits: 2, prerequisites: ['INDC0003'] },

            // Semestre 7
            { id: 'INFB8072', name: 'Ingenieria de Software', semester: 7, credits: 3, prerequisites: ['INFOB072'] },
            { id: 'INFB8081', name: 'Sistemas Operativos', semester: 7, credits: 2, prerequisites: ['INFB8060'] },
            { id: 'FITCXX03', name: 'Formacion Sello Sustentabilidad', semester: 7, credits: 2, prerequisites: ['INFOB072'] },
            { id: 'FITCX003', name: 'Formación Sello Sustentabilidad', semester: 7, credits: 2, prerequisites: [] },
            { id: 'HUMCX002', name: 'Inglés II', semester: 7, credits: 2, prerequisites: ['HUMCX001'] },
            { id: 'INFOB082', name: 'Taller de Sistemas de Información', semester: 7, credits: 2, prerequisites: ['INFOB081'] },

            // Semestre 8
            { id: 'INFOB093', name: 'Simulación de Sistemas', semester: 8, credits: 3, prerequisites: ['INFOB080'] },
            { id: 'INFOB083', name: 'Evaluación de Proyectos Informáticos', semester: 8, credits: 2, prerequisites: ['INFOB080'] },
            { id: 'INFOB090', name: 'Computación Paralela y Distribuida', semester: 8, credits: 2, prerequisites: ['INFOB081'] },
            { id: 'INFOB091', name: 'Desempeño de Proyectos Informáticos', semester: 8, credits: 2, prerequisites: ['INFOB083'] },
            { id: 'INFOB092', name: 'Auditoría y Seguridad Informática', semester: 8, credits: 2, prerequisites: ['INFOB082'] },
            { id: 'HUMCX003', name: 'Inglés III', semester: 8, credits: 2, prerequisites: ['HUMCX002'] },

            // Semestre 9
            { id: 'EFEBMXX', name: 'Electivo de Formación Especializada I', semester: 9, credits: 3, prerequisites: [] },
            { id: 'INFOB003', name: 'Trabajo de Título I', semester: 9, credits: 2, prerequisites: ['INFOB093', 'INFOB090', 'INFOB091', 'INFOB092'] },
            { id: 'FITCX007', name: 'Formación Sello Tecnología', semester: 9, credits: 2, prerequisites: [] },
            { id: 'INFOB103', name: 'Gestión de Proyectos Informáticos', semester: 9, credits: 2, prerequisites: ['INFOB091'] },
            { id: 'INFOB104', name: 'Minería de Datos', semester: 9, credits: 2, prerequisites: ['INFOB092'] },

            // Semestre 10
            { id: 'EFEBMXX2', name: 'Electivo de Formación Especializada II', semester: 10, credits: 3, prerequisites: [] },
            { id: 'INFOB004', name: 'Trabajo de Título II', semester: 10, credits: 2, prerequisites: ['INFOB003'] },
            { id: 'INFOB002', name: 'Optimización de Sistemas', semester: 10, credits: 2, prerequisites: ['INFOB103', 'INFOB104'] },
            { id: 'INFOB100', name: 'Gestión de Recursos Informáticos', semester: 10, credits: 2, prerequisites: ['INFOB103'] },

            // Semestre 11
            { id: 'INFBY120', name: 'Trabajo de Título III', semester: 11, credits: 2, prerequisites: ['INFOB004'] },
            { id: 'INFBY100', name: 'Práctica Profesional', semester: 11, credits: 2, prerequisites: ['INFOB004'] },
            { id: 'FITCX006', name: 'Taller de Empleabilidad', semester: 11, credits: 2, prerequisites: [] }
        ];

        const curriculumGrid = document.getElementById('curriculum-grid');
        const courseDetailsPanel = document.getElementById('course-details');
        const detailName = document.getElementById('detail-name');
        const detailCredits = document.getElementById('detail-credits');
        const detailSemester = document.getElementById('detail-semester');
        const detailPrerequisites = document.getElementById('detail-prerequisites');
        const detailPostrequisites = document.getElementById('detail-postrequisites');
        const closeDetailsButton = document.getElementById('close-details');

        let selectedCourseId = null;
        let completedCoursesSet = new Set();

        /**
         * Carga los IDs de los cursos completados desde Firestore en tiempo real.
         * Se suscribe a los cambios en el documento de progreso del usuario.
         */
        function loadCompletedCoursesFromFirestore() {
            showLoading(true);
            // Ruta del documento para datos privados del usuario en Firestore
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/completedCourses`, 'userProgress');

            // onSnapshot proporciona actualizaciones en tiempo real
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Los cursos se guardan como un JSON string, así que se parsean al leer
                    const completedCoursesArray = data.completedCourses ? JSON.parse(data.completedCourses) : [];
                    completedCoursesSet = new Set(completedCoursesArray);
                    console.log("Cursos completados cargados de Firestore:", Array.from(completedCoursesSet));
                } else {
                    console.log("No hay datos de progreso para este usuario en Firestore.");
                    completedCoursesSet = new Set(); // Reinicia si no hay datos guardados
                }
                renderCurriculum(); // Vuelve a renderizar la malla con los datos actualizados
                showLoading(false);
            }, (error) => {
                console.error("Error al cargar los cursos completados de Firestore:", error);
                showLoading(false);
            });
        }

        /**
         * Guarda los IDs de los cursos completados en Firestore.
         * Se llama cada vez que se marca o desmarca un curso.
         */
        async function saveCompletedCoursesToFirestore() {
            if (!userId || !db) {
                console.error("Firestore o userId no están listos para guardar.");
                return;
            }
            showLoading(true);
            try {
                // Ruta del documento para guardar el progreso del usuario
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/completedCourses`, 'userProgress');
                // Convierte el Set de IDs a un Array y luego a un JSON string para guardarlo
                const dataToSave = {
                    completedCourses: JSON.stringify(Array.from(completedCoursesSet))
                };
                await setDoc(userDocRef, dataToSave, { merge: true }); // Usa merge para no sobrescribir otros campos
                console.log("Cursos completados guardados en Firestore.");
            } catch (error) {
                console.error("Error al guardar los cursos completados en Firestore:", error);
            } finally {
                showLoading(false);
            }
        }

        /**
         * Obtiene los nombres de los pre-requisitos no completados para un curso dado.
         * Se usa para el mensaje de cursos bloqueados.
         * @param {string} courseId - El ID del curso.
         * @returns {string[]} Un array con los nombres de los pre-requisitos no completados.
         */
        function getUncompletedPrerequisites(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return [];
            return course.prerequisites
                .filter(preReqId => !completedCoursesSet.has(preReqId))
                .map(preReqId => courses.find(c => c.id === preReqId)?.name || 'Curso Desconocido');
        }

        /**
         * Determina si un curso está bloqueado (no tiene todos sus pre-requisitos completados).
         * @param {string} courseId - El ID del curso a verificar.
         * @returns {boolean} True si el curso está bloqueado, false en caso contrario.
         */
        function isCourseLocked(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return true;
            return course.prerequisites.some(preReqId => !completedCoursesSet.has(preReqId));
        }

        /**
         * Muestra un mensaje persistente en la parte superior de la cuadrícula.
         * @param {string} message - El mensaje a mostrar.
         * @param {boolean} isActive - True para mostrar el mensaje, false para ocultarlo.
         */
        function displayLockedCourseMessage(message, isActive) {
            if (isActive) {
                lockedCourseInfoDiv.textContent = message;
                lockedCourseInfoDiv.classList.add('active');
            } else {
                lockedCourseInfoDiv.classList.remove('active');
                lockedCourseInfoDiv.textContent = ''; // Limpia el texto cuando no está activo
            }
        }

        /**
         * Alterna el estado de completado de un curso y actualiza su estado visual y en Firestore.
         * @param {string} courseId - El ID del curso a alternar.
         * @param {boolean} isCompleted - El nuevo estado de completado.
         */
        async function toggleCourseCompletion(courseId, isCompleted) {
            const courseCard = document.getElementById(`course-${courseId}`);
            const toggleIconContainer = courseCard.querySelector('.toggle-completion-icon');
            const svgIcon = toggleIconContainer.querySelector('svg');

            if (isCompleted) {
                completedCoursesSet.add(courseId);
                courseCard.classList.add('completed');
                courseCard.classList.remove('available'); // Remueve la clase 'available' si se completa
                toggleIconContainer.classList.remove('uncompleted');
                toggleIconContainer.classList.add('completed');
                // Cambia el SVG a un cuadrado con check
                svgIcon.innerHTML = '<path d="M9 12l2 2 4-4m-6 4a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H9a2 2 0 01-2-2z" />';
                svgIcon.setAttribute('fill', 'currentColor');
            } else {
                completedCoursesSet.delete(courseId);
                courseCard.classList.remove('completed');
                toggleIconContainer.classList.remove('completed');
                toggleIconContainer.classList.add('uncompleted');
                // Cambia el SVG a un cuadrado vacío
                svgIcon.innerHTML = '<rect x="4" y="4" width="16" height="16" rx="3" ry="3" />';
                svgIcon.setAttribute('fill', 'none');

                // Si se desmarca como completado, verifica si ahora está bloqueado o disponible
                if (isCourseLocked(courseId)) {
                    courseCard.classList.add('locked');
                } else {
                    courseCard.classList.add('available');
                }
            }
            await saveCompletedCoursesToFirestore(); // Guarda los cambios en Firestore
            // renderCurriculum() se llamará automáticamente por el onSnapshot de Firestore,
            // asegurando que la UI se actualice con los nuevos estados de desbloqueo.
        }

        /**
         * Renderiza la cuadrícula de la malla, agrupando cursos por semestre.
         * Aplica los estados visuales de completado, disponible y bloqueado.
         */
        function renderCurriculum() {
            // Agrupa los cursos por semestre para una visualización organizada
            const semesters = {};
            courses.forEach(course => {
                if (!semesters[course.semester]) {
                    semesters[course.semester] = [];
                }
                semesters[course.semester].push(course);
            });

            curriculumGrid.innerHTML = ''; // Limpia el contenido previo de la cuadrícula
            displayLockedCourseMessage('', false); // Oculta el mensaje de bloqueo al renderizar

            // Ordena los semestres numéricamente
            const sortedSemesters = Object.keys(semesters).sort((a, b) => parseInt(a) - parseInt(b));

            sortedSemesters.forEach(semesterNum => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'semester-column bg-gray-100 p-4 rounded-xl shadow-inner';
                semesterDiv.innerHTML = `<h3 class="text-xl font-semibold text-gray-700 mb-4 text-center">Semestre ${semesterNum}</h3>`;

                semesters[semesterNum].forEach(course => {
                    const courseCard = document.createElement('div');
                    courseCard.id = `course-${course.id}`;
                    courseCard.className = 'course-card';

                    const isCompleted = completedCoursesSet.has(course.id);
                    // Un curso no puede estar bloqueado y completado a la vez
                    const isLocked = !isCompleted && isCourseLocked(course.id);

                    // Aplica las clases CSS según el estado del curso
                    if (isCompleted) {
                        courseCard.classList.add('completed');
                    } else if (isLocked) {
                        courseCard.classList.add('locked');
                        // Añade el título para el tooltip de cursos bloqueados
                        const uncompletedReqs = getUncompletedPrerequisites(course.id);
                        if (uncompletedReqs.length > 0) {
                            courseCard.title = `Necesitas completar: ${uncompletedReqs.join(', ')} para desbloquear este curso.`;
                        } else {
                            courseCard.title = 'Este curso está bloqueado.'; // Fallback si no hay pre-requisitos
                        }
                    } else {
                        courseCard.classList.add('available'); // Desbloqueado y no completado
                    }

                    // Crea el icono de alternar completado (cuadrado SVG)
                    const toggleIconContainer = document.createElement('div');
                    toggleIconContainer.className = `toggle-completion-icon ${isCompleted ? 'completed' : 'uncompleted'} ${isLocked ? 'locked-icon' : ''}`;
                    toggleIconContainer.dataset.courseId = course.id;

                    const svgIcon = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    svgIcon.setAttribute("viewBox", "0 0 24 24");
                    svgIcon.setAttribute("stroke", "currentColor");
                    svgIcon.setAttribute("stroke-width", "2");

                    if (isCompleted) {
                        svgIcon.setAttribute("fill", "currentColor");
                        svgIcon.innerHTML = '<path d="M9 12l2 2 4-4m-6 4a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H9a2 2 0 01-2-2z" />';
                    } else {
                        svgIcon.setAttribute("fill", "none");
                        svgIcon.innerHTML = '<rect x="4" y="4" width="16" height="16" rx="3" ry="3" />';
                    }

                    toggleIconContainer.appendChild(svgIcon);
                    // Añade el evento de clic al icono para alternar el estado de completado
                    toggleIconContainer.addEventListener('click', (event) => {
                        event.stopPropagation(); // Evita que el clic en el icono active la selección de la tarjeta
                        if (!isLocked) { // Solo permite alternar si el curso no está bloqueado
                            toggleCourseCompletion(course.id, !completedCoursesSet.has(course.id));
                        }
                    });
                    courseCard.appendChild(toggleIconContainer);

                    // Contenido principal del curso (nombre y créditos)
                    const courseContent = document.createElement('div');
                    courseContent.className = 'flex flex-col justify-center items-center w-full h-full';
                    courseContent.innerHTML = `
                        <p class="font-medium text-gray-800 text-lg course-name">${course.name}</p>
                        <p class="text-sm text-gray-500 course-credits">${course.credits} Créditos</p>
                    `;
                    courseCard.appendChild(courseContent);

                    // Añade el evento de clic a la tarjeta para seleccionar y mostrar detalles
                    courseCard.addEventListener('click', () => {
                        if (isLocked) {
                            // Si el curso está bloqueado, muestra un mensaje persistente
                            displayLockedCourseMessage(courseCard.title, true);
                        } else {
                            // Si no está bloqueado, selecciona el curso y muestra sus detalles
                            selectCourse(course.id);
                            displayLockedCourseMessage('', false); // Oculta el mensaje si se selecciona un curso no bloqueado
                        }
                    });
                    // Agrega evento mouseleave para ocultar el mensaje cuando el mouse sale de un curso bloqueado
                    courseCard.addEventListener('mouseleave', () => {
                        if (isLocked) {
                            displayLockedCourseMessage('', false);
                        }
                    });
                    semesterDiv.appendChild(courseCard);
                });
                curriculumGrid.appendChild(semesterDiv);
            });
        }

        /**
         * Maneja la selección de un curso, mostrando sus detalles en el panel lateral
         * y resaltando sus pre-requisitos y post-requisitos en la malla.
         * @param {string} courseId - El ID del curso seleccionado.
         */
        function selectCourse(courseId) {
            // Remueve las clases de selección y resaltado de todas las tarjetas
            document.querySelectorAll('.course-card').forEach(card => {
                card.classList.remove('selected', 'prerequisite', 'post-requisite');
            });

            const selectedCourse = courses.find(c => c.id === courseId);
            if (!selectedCourse) {
                console.error('Curso no encontrado:', courseId);
                return;
            }

            // Resalta la tarjeta del curso seleccionado
            document.getElementById(`course-${courseId}`).classList.add('selected');
            selectedCourseId = courseId;

            // Actualiza el panel de detalles con la información del curso seleccionado
            detailName.textContent = selectedCourse.name;
            detailCredits.textContent = selectedCourse.credits;
            detailSemester.textContent = selectedCourse.semester;

            // Limpia las listas de pre-requisitos y post-requisitos
            detailPrerequisites.innerHTML = '';
            detailPostrequisites.innerHTML = '';

            // Muestra y resalta los pre-requisitos
            if (selectedCourse.prerequisites.length > 0) {
                selectedCourse.prerequisites.forEach(preReqId => {
                    const preReqCourse = courses.find(c => c.id === preReqId);
                    if (preReqCourse) {
                        const listItem = document.createElement('li');
                        listItem.textContent = preReqCourse.name;
                        detailPrerequisites.appendChild(listItem);
                        const preReqCard = document.getElementById(`course-${preReqId}`);
                        // Solo resalta si el pre-requisito no está completado
                        if (preReqCard && !completedCoursesSet.has(preReqId)) {
                            preReqCard.classList.add('prerequisite');
                        }
                    }
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'Ninguno';
                detailPrerequisites.appendChild(listItem);
            }

            // Muestra y resalta los post-requisitos
            const postRequisites = courses.filter(c => c.prerequisites.includes(courseId));
            if (postRequisites.length > 0) {
                postRequisites.forEach(postReqCourse => {
                    const listItem = document.createElement('li');
                    listItem.textContent = postReqCourse.name;
                    detailPostrequisites.appendChild(listItem);
                    const postReqCard = document.getElementById(`course-${postReqCourse.id}`);
                    // Solo resalta si el post-requisito no está completado y no está bloqueado
                    if (postReqCard && !completedCoursesSet.has(postReqCourse.id) && !isCourseLocked(postReqCourse.id)) {
                        postReqCard.classList.add('post-requisite');
                    }
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'Ninguno';
                detailPostrequisites.appendChild(listItem);
            }

            courseDetailsPanel.classList.remove('hidden'); // Muestra el panel de detalles
        }

        // Event listener para el botón "Cerrar Detalles"
        closeDetailsButton.addEventListener('click', () => {
            courseDetailsPanel.classList.add('hidden'); // Oculta el panel de detalles
            // Remueve las clases de selección y resaltado de todas las tarjetas
            document.querySelectorAll('.course-card').forEach(card => {
                card.classList.remove('selected', 'prerequisite', 'post-requisite');
            });
            selectedCourseId = null; // Reinicia el curso seleccionado
        });

        // La renderización inicial de la malla se dispara automáticamente
        // después de que Firebase autentica al usuario y carga los datos.
    </script>
</body>
</html>
